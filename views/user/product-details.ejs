<%- include("../../views/partials/user/header", { currentPage: 'productDetails' }) %>

<main class="main">
    <!-- Breadcrumb -->
    <div class="page-header">
        <div class="container">
            <nav class="breadcrumb-nav">
                <a href="/">Home</a>
                <span>/</span>
                <a href="/shop">Shop</a>
                <span>/</span>
                <span>Product Detail Page</span>
            </nav>
        </div>
    </div>

    <section class="product-section">
        <div class="container">
            <div class="row">
                <!-- Left Column - Product Images -->
                <div class="col-md-6">
                    <div class="product-gallery">
                        <!-- Main Image with Dynamic Zoom -->
                        <div class="main-image-container">
                            <div class="zoom-wrapper">
                                <img src="/uploads/re-image/<%= product.productImage[0] %>"
                                     alt="<%= product.productName %>"
                                     class="main-image"
                                     id="mainImage">
                            </div>
                        </div>

                        <!-- Thumbnail Images -->
                        <div class="thumbnail-container">
                            <% product.productImage.forEach((image, index) => { %>
                                <div class="thumbnail-item <%= index === 0 ? 'active' : '' %>">
                                    <img src="/uploads/re-image/<%= image %>" alt="Thumbnail <%= index + 1 %>">
                                </div>
                            <% }) %>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="product-details">
                        <h1 class="product-title"><%= product.productName %></h1>

                        <div class="product-meta">
                            <div class="brand">
                                Brands: <a href="#"><%= product.brand %></a>
                            </div>
                            <div class="reviews">
                                <div class="stars">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star-half-alt"></i>
                                </div>
                                <span>(25 reviews)</span>
                            </div>
                        </div>

                        <div class="product-price">
                            <span class="current-price">₹<%= product.salePrice %></span>
                            <span class="original-price">₹<%= product.regularPrice %></span>
                            <% if(totalOffer) { %>
                                <span class="discount"><%= totalOffer %>% Offer</span>
                            <% } %>
                        </div>

                        <p class="product-description">
                            <%= product.description %>
                        </p>

                        <ul class="product-features">
                            <li><i class="fi-rs-crown"></i> 1 Year Brand Warranty</li>
                            <li><i class="fi-rs-refresh"></i> 30 Day Return Policy</li>
                            <li><i class="fi-rs-credit-card"></i> Cash on Delivery available</li>
                        </ul>

                        <div class="add-to-cart-section">
                            <div class="quantity-selector">
                                <button class="qty-btn minus">-</button>
                                <input type="number" value="1" min="1" class="qty-input">
                                <button class="qty-btn plus">+</button>
                            </div>
                            <button class="add-to-cart-btn" onclick="addToCart('<%= product._id %>')">Add to cart</button>
                            <button class="wishlist-btn" id="wishlistBtn" onclick="toggleWishlist('<%= product._id %>')">
                                <i class="fas fa-heart" id="wishlistHeart"></i>
                            </button>
                        </div>

                        <div class="product-meta-info">
                            <div>Stock Code: <span>FWM15VKT</span></div>
                            <div>Tags: <a href="#"><%= category.name %></a></div>
                            <div>Availability: <span class="in-stock"><%= quantity %> Items in Stock</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <% if (relatedProducts && relatedProducts.length > 0) { %>
        <section class="related-products-section">
            <div class="container">
                <h2 class="section-title">Related Products</h2>
                <div class="related-products-slider">
                    <% relatedProducts.forEach(relatedProduct => { %>
                        <div class="product-card">
                            <div class="product-image">
                                <a href="/product-details?id=<%= relatedProduct._id %>">
                                    <img src="/uploads/re-image/<%= relatedProduct.productImage[0] %>"
                                         alt="<%= relatedProduct.productName %>">
                                </a>
                            </div>
                            <div class="product-info">
                                <h3 class="product-name">
                                    <a href="/product-details?id=<%= relatedProduct._id %>">
                                        <%= relatedProduct.productName %>
                                    </a>
                                </h3>
                                <div class="product-price">
                                    <span class="current-price">₹<%= relatedProduct.salePrice %></span>
                                    <% if (relatedProduct.regularPrice) { %>
                                        <span class="original-price">₹<%= relatedProduct.regularPrice %></span>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        </section>
    <% } %>
</main>

<style>
.main {
    padding-top: 20px;
}

.page-header {
    background-color: #f7f8fa;
    padding: 15px 0;
}

.breadcrumb-nav {
    font-size: 14px;
}

.breadcrumb-nav a {
    color: #333;
    text-decoration: none;
}

.breadcrumb-nav span {
    margin: 0 10px;
    color: #999;
}

.product-section {
    padding: 40px 0;
}

.product-gallery {
    position: relative;
}

.main-image-container {
    position: relative;
    background-color: #f7f8fa;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 20px;
    width: 100%;
    padding-top: 100%; /* Default 1:1 aspect ratio, adjusted by JS */
}

.zoom-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
}

.main-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain; /* Ensures full image is visible without cropping */
    transform-origin: center center;
    transition: transform 0.1s ease;
}

.thumbnail-container {
    display: flex;
    gap: 10px;
}

.thumbnail-item {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
}

.thumbnail-item.active {
    border: 2px solid #3BB77E;
}

.thumbnail-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.product-title {
    font-size: 24px;
    margin-bottom: 20px;
    color: #253D4E;
}

.product-meta {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
}

.brand a {
    color: #3BB77E;
    text-decoration: none;
}

.product-price {
    margin-bottom: 20px;
}

.current-price {
    font-size: 32px;
    color: #3BB77E;
    font-weight: bold;
    margin-right: 15px;
}

.original-price {
    color: #999;
    text-decoration: line-through;
}

.discount {
    color: #dc3545;
    margin-left: 15px;
}

.product-features {
    list-style: none;
    padding: 0;
    margin: 20px 0;
}

.product-features li {
    margin-bottom: 10px;
    display: flex;
    align-items: center;
}

.product-features i {
    margin-right: 10px;
    color: #3BB77E;
}

.add-to-cart-section {
    display: flex;
    gap: 15px;
    margin: 30px 0;
}

.quantity-selector {
    display: flex;
    align-items: center;
    border: 1px solid #e5e5e5;
    border-radius: 5px;
}

.qty-btn {
    width: 40px;
    height: 40px;
    border: none;
    background: none;
    cursor: pointer;
}

.qty-input {
    width: 50px;
    text-align: center;
    border: none;
    font-size: 16px;
}

.add-to-cart-btn {
    background-color: #3BB77E;
    color: white;
    border: none;
    padding: 0 30px;
    border-radius: 5px;
    cursor: pointer;
}

.wishlist-btn {
    width: 40px;
    height: 40px;
    border: 1px solid #e5e5e5;
    background: none;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.wishlist-btn .fas.fa-heart {
    color: #999; /* Default color when not in wishlist */
    transition: color 0.3s ease; /* Smooth color transition */
}

.wishlist-btn.in-wishlist .fas.fa-heart {
    color: #dc3545; /* Red color when in wishlist */
}

.related-products-section {
    padding: 60px 0;
    background-color: #f8f9fa;
}

.section-title {
    text-align: center;
    margin-bottom: 40px;
    color: #253D4E;
    font-size: 28px;
}

.related-products-slider {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 30px;
    margin: 0 -15px;
}

.product-card {
    background: #fff;
    border-radius: 10px;
    padding: 15px;
    transition: box-shadow 0.3s ease;
}

.product-card:hover {
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.product-card .product-image {
    position: relative;
    height: 200px;
    margin-bottom: 15px;
}

.product-card .product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
}

.product-card .product-name {
    font-size: 16px;
    margin-bottom: 10px;
}

.product-card .product-name a {
    color: #253D4E;
    text-decoration: none;
}

.product-card .product-price {
    display: flex;
    gap: 10px;
    align-items: center;
}

.product-meta-info {
    color: #7E7E7E;
    font-size: 14px;
}

.product-meta-info > div {
    margin-bottom: 10px;
}

.in-stock {
    color: #3BB77E;
}

@media (max-width: 768px) {
    .related-products-slider {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }

    .main-image-container {
        padding-top: 100%; /* Maintain aspect ratio on mobile */
    }
}
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Quantity selector functionality
    const minusBtn = document.querySelector('.minus');
    const plusBtn = document.querySelector('.plus');
    const qtyInput = document.querySelector('.qty-input');

    minusBtn.addEventListener('click', () => {
        const currentValue = parseInt(qtyInput.value);
        if (currentValue > 1) {
            qtyInput.value = currentValue - 1;
        }
    });

    plusBtn.addEventListener('click', () => {
        const currentValue = parseInt(qtyInput.value);
        qtyInput.value = currentValue + 1;
    });

    // Thumbnail switching functionality
    const thumbnails = document.querySelectorAll('.thumbnail-item img');
    const mainImage = document.getElementById('mainImage');
    const zoomWrapper = document.querySelector('.zoom-wrapper');
    const mainImageContainer = document.querySelector('.main-image-container');

    // Adjust container height based on image aspect ratio
    function adjustContainerHeight() {
        const img = new Image();
        img.src = mainImage.src;
        img.onload = function() {
            const aspectRatio = img.height / img.width;
            mainImageContainer.style.paddingTop = `${aspectRatio * 100}%`;
        };
    }

    adjustContainerHeight(); // Initial adjustment

    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', function () {
            thumbnails.forEach(t => t.parentElement.classList.remove('active'));
            this.parentElement.classList.add('active');
            const newImageSrc = this.getAttribute('src');
            mainImage.src = newImageSrc;
            adjustContainerHeight(); // Adjust height for new image
        });
    });

    // Dynamic zoom functionality
    const zoomFactor = 2; // Adjust zoom level here

    zoomWrapper.addEventListener('mousemove', (e) => {
        const rect = zoomWrapper.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // Calculate transform origin based on mouse position
        const originX = (x / rect.width) * 100;
        const originY = (y / rect.height) * 100;

        mainImage.style.transformOrigin = `${originX}% ${originY}%`;
        mainImage.style.transform = `scale(${zoomFactor})`;
    });

    zoomWrapper.addEventListener('mouseleave', () => {
        mainImage.style.transform = 'scale(1)';
        mainImage.style.transformOrigin = 'center center';
    });

    // Check if product is already in wishlist on page load
    checkWishlistStatus('<%= product._id %>');
});

function updateCartCount(count) {
    document.getElementById('cart-count').innerText = count;
}

function addToCart(productId) {
    const quantity = document.querySelector('.qty-input').value;
    $.ajax({
        url: '/addToCart',
        method: 'POST',
        data: { productId: productId, quantity: quantity },
        success: (response) => {
            Swal.fire({
                title: 'Success',
                text: response.message,
                icon: 'success',
                timer: 3000
            });
            if (response.cartCount) updateCartCount(response.cartCount);
        },
        error: (error) => {
            Swal.fire({
                title: 'Error',
                text: error.responseJSON?.message || 'There was an error adding the product to your cart',
                icon: 'error',
                timer: 3000
            });
        }
    });
}

// New function to check wishlist status
function checkWishlistStatus(productId) {
    $.ajax({
        url: '/getWishlistCount', // Assuming this endpoint can be modified to check specific product
        method: 'GET',
        success: (response) => {
            // Assuming response contains an array of wishlist items or a count
            $.ajax({
                url: '/checkProductInWishlist', // New endpoint needed to check specific product
                method: 'POST',
                data: { productId: productId },
                success: (result) => {
                    const wishlistBtn = document.getElementById('wishlistBtn');
                    if (result.inWishlist) {
                        wishlistBtn.classList.add('in-wishlist');
                    } else {
                        wishlistBtn.classList.remove('in-wishlist');
                    }
                },
                error: (error) => {
                    console.error('Error checking wishlist status:', error);
                }
            });
        },
        error: (error) => {
            console.error('Error fetching wishlist count:', error);
        }
    });
}

// Updated function to toggle wishlist and change heart color
function toggleWishlist(productId) {
    const wishlistBtn = document.getElementById('wishlistBtn');
    const isInWishlist = wishlistBtn.classList.contains('in-wishlist');

    if (isInWishlist) {
        // Remove from wishlist
        $.ajax({
            url: '/removeFromWishlist',
            method: 'GET',
            data: { productId: productId },
            success: (response) => {
                if (response.success) {
                    wishlistBtn.classList.remove('in-wishlist');
                    Swal.fire({
                        title: 'Removed from Wishlist',
                        text: 'The product has been removed from your wishlist',
                        icon: 'success',
                        timer: 2000
                    });
                }
            },
            error: (error) => {
                Swal.fire({
                    title: 'Error',
                    text: 'There was an error removing the product from your wishlist',
                    icon: 'error',
                    timer: 2000
                });
            }
        });
    } else {
        // Add to wishlist
        $.ajax({
            url: '/addToWishlist',
            method: 'POST',
            data: { productId: productId },
            success: (response) => {
                if (response.status) {
                    wishlistBtn.classList.add('in-wishlist');
                    Swal.fire({
                        title: 'Added to Wishlist',
                        text: 'The product has been added to your wishlist',
                        icon: 'success',
                        timer: 2000
                    });
                } else {
                    Swal.fire({
                        title: 'Already in Wishlist',
                        text: response.message,
                        icon: 'info',
                        timer: 2000
                    });
                }
            },
            error: (error) => {
                Swal.fire({
                    title: 'Error',
                    text: 'There was an error adding the product to your wishlist',
                    icon: 'error',
                    timer: 2000
                });
            }
        });
    }
}
</script>

<%- include("../../views/partials/user/footer") %>